<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Abrir Archivos</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1177bb;
        }
        .output {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            min-height: 200px;
            font-family: monospace;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .info { color: #569cd6; }
        .warning { color: #dcdcaa; }
    </style>
</head>
<body>
    <h1>üêü Test de Apertura de Archivos - Samaruc Code</h1>
    
    <div>
        <button class="btn" onclick="testFileDialog()">
            üìÇ Probar Abrir Archivo (HTML5)
        </button>
        <button class="btn" onclick="testDebug()">
            üîç Debug Info
        </button>
        <button class="btn" onclick="testDirectOpen()">
            ‚ö° Prueba Directa
        </button>
        <button class="btn" onclick="clearOutput()">
            üóëÔ∏è Limpiar
        </button>
    </div>
    
    <div id="output" class="output">
        <div class="info">[INFO] Listo para probar...</div>
    </div>

    <script>
        // Simular las funciones necesarias
        let openFiles = new Map();
        let activeFile = null;
        let recentFiles = [];
        
        // Funci√≥n para a√±adir output
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        // Funci√≥n para limpiar output
        function clearOutput() {
            document.getElementById('output').innerHTML = '<div class="info">[INFO] Output limpiado...</div>';
        }
        
        // Simular path.basename
        const path = {
            basename: (filePath) => {
                return filePath.split(/[\\/]/).pop();
            },
            extname: (filePath) => {
                const name = path.basename(filePath);
                const lastDot = name.lastIndexOf('.');
                return lastDot > 0 ? name.substring(lastDot) : '';
            }
        };
        
        // Funci√≥n para obtener lenguaje
        function getLanguageFromFile(filePath) {
            const ext = path.extname(filePath).toLowerCase();
            const map = {
                '.c': 'c', '.h': 'c', '.cpp': 'cpp', '.js': 'javascript',
                '.html': 'html', '.css': 'css', '.py': 'python', '.md': 'markdown'
            };
            return map[ext] || 'plaintext';
        }
        
        // Funci√≥n para detectar archivos binarios
        function isBinaryFile(content) {
            const binaryChars = /[\x00-\x08\x0E-\x1F\x7F]/;
            const sample = content.substring(0, 1024);
            const controlChars = (sample.match(binaryChars) || []).length;
            return (controlChars / sample.length) > 0.3;
        }
        
        // Funci√≥n para formatear tama√±o
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Simular funciones de UI
        function createTab(filePath) {
            addOutput(`Tab creada para: ${path.basename(filePath)}`, 'success');
        }
        
        function switchToFile(filePath) {
            activeFile = filePath;
            addOutput(`Cambiado a archivo: ${path.basename(filePath)}`, 'info');
        }
        
        function updateWindowTitle(filePath) {
            document.title = `Samaruc Code - ${path.basename(filePath)}`;
        }
        
        function addToRecentFiles(filePath) {
            recentFiles.unshift(filePath);
            if (recentFiles.length > 10) recentFiles.pop();
            addOutput(`A√±adido a recientes: ${path.basename(filePath)}`, 'info');
        }
        
        // Funci√≥n principal: openFileInEditor
        function openFileInEditor(filePath, content, isNew = false) {
            addOutput(`openFileInEditor llamada: ${filePath}`, 'info');
            
            if (!filePath || content === undefined) {
                addOutput('Error: Par√°metros inv√°lidos', 'error');
                return;
            }
            
            if (openFiles.has(filePath)) {
                switchToFile(filePath);
                addOutput(`Archivo ya abierto: ${path.basename(filePath)}`, 'warning');
                return;
            }
            
            const language = getLanguageFromFile(filePath);
            addOutput(`Detectado lenguaje: ${language}`, 'info');
            
            if (typeof content !== 'string') {
                try {
                    content = String(content);
                } catch (error) {
                    addOutput('Error: Contenido no v√°lido', 'error');
                    return;
                }
            }
            
            if (content.length > 2 * 1024 * 1024) {
                const fileSize = (content.length / (1024 * 1024)).toFixed(2);
                if (!confirm(`Archivo muy grande (${fileSize}MB). ¬øContinuar?`)) {
                    addOutput('Apertura cancelada por tama√±o', 'warning');
                    return;
                }
            }
            
            if (isBinaryFile(content)) {
                if (!confirm(`Archivo binario detectado. ¬øAbrir como texto?`)) {
                    addOutput('Apertura de binario cancelada', 'warning');
                    return;
                }
            }
            
            openFiles.set(filePath, {
                content: content,
                modified: isNew,
                isNew: isNew,
                language: language,
                fileSize: content.length,
                lastModified: new Date(),
                encoding: 'utf-8'
            });
            
            createTab(filePath);
            switchToFile(filePath);
            updateWindowTitle(filePath);
            
            if (!isNew && (filePath.includes('/') || filePath.includes('\\\\'))) {
                addToRecentFiles(filePath);
            }
            
            addOutput(`‚úÖ Archivo abierto: ${path.basename(filePath)} (${language}, ${formatFileSize(content.length)})`, 'success');
        }
        
        // Funci√≥n de prueba del di√°logo HTML5
        function testFileDialog() {
            addOutput('Probando di√°logo HTML5...', 'info');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.c,.h,.cpp,.js,.html,.css,.py,.md,.txt,*';
            input.multiple = false;
            input.style.display = 'none';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    addOutput(`Archivo seleccionado: ${file.name}`, 'info');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        openFileInEditor(file.name, content, true);
                    };
                    
                    reader.onerror = () => {
                        addOutput(`Error leyendo archivo: ${file.name}`, 'error');
                    };
                    
                    reader.readAsText(file, 'utf-8');
                } else {
                    addOutput('No se seleccion√≥ archivo', 'warning');
                }
                
                // Limpiar
                document.body.removeChild(input);
            };
            
            input.oncancel = () => {
                addOutput('Selecci√≥n cancelada', 'info');
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }
        
        // Funci√≥n de debug
        function testDebug() {
            addOutput('=== DEBUG INFO ===', 'info');
            addOutput(`openFiles: ${openFiles.size} archivos`, 'info');
            addOutput(`activeFile: ${activeFile || 'ninguno'}`, 'info');
            addOutput(`recentFiles: ${recentFiles.length} archivos`, 'info');
            addOutput(`FileReader disponible: ${typeof FileReader !== 'undefined'}`, 'info');
            addOutput(`Blob disponible: ${typeof Blob !== 'undefined'}`, 'info');
            addOutput('=== FIN DEBUG ===', 'info');
        }
        
        // Funci√≥n de prueba directa
        function testDirectOpen() {
            addOutput('Probando apertura directa...', 'info');
            
            const testContent = `#include <stdio.h>

int main() {
    printf("¬°Archivo de prueba abierto correctamente!\\n");
    return 0;
}`;
            
            openFileInEditor('test-direct.c', testContent, true);
        }
    </script>
</body>
</html>
