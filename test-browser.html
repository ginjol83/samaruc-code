<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test - Abrir Archivos</title>
    <!-- Prism.js para resaltado de sintaxis -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #1e1e1e;
            color: #d4d4d4;
        }
        .btn {
            background: #0e639c;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #1177bb;
        }
        .output {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            min-height: 200px;
            font-family: monospace;
        }
        .success { color: #4ec9b0; }
        .error { color: #f44747; }
        .info { color: #569cd6; }
        .warning { color: #dcdcaa; }
        
        .code-editor {
            background: #2d2d30;
            border: 1px solid #3e3e42;
            padding: 0;
            margin: 20px 0;
            border-radius: 4px;
            min-height: 300px;
            font-family: 'Consolas', 'Monaco', monospace;
            overflow: auto;
        }
        
        .code-editor pre {
            margin: 0;
            padding: 15px;
            background: transparent;
            color: #d4d4d4;
            font-size: 14px;
            line-height: 1.5;
        }
        
        .code-editor code {
            font-family: 'Consolas', 'Monaco', monospace;
        }
        
        .file-info {
            background: #252526;
            padding: 10px;
            border-bottom: 1px solid #3e3e42;
            font-size: 12px;
            color: #cccccc;
        }
    </style>
</head>
<body>
    <h1>üêü Test de Apertura de Archivos - Samaruc Code</h1>
    
    <div>
        <button class="btn" onclick="testFileDialog()">
            üìÇ Probar Abrir Archivo (HTML5)
        </button>
        <button class="btn" onclick="testDebug()">
            üîç Debug Info
        </button>
        <button class="btn" onclick="testDirectOpen()">
            ‚ö° Prueba Directa (C)
        </button>
        <button class="btn" onclick="testCppExample()">
            üîß Ejemplo C++
        </button>
        <button class="btn" onclick="clearOutput()">
            üóëÔ∏è Limpiar
        </button>
    </div>
    
    <div id="output" class="output">
        <div class="info">[INFO] Listo para probar...</div>
    </div>

    <div id="code-container" class="code-editor" style="display: none;">
        <div id="file-info" class="file-info">
            Ning√∫n archivo abierto
        </div>
        <pre><code id="code-display" class="language-c"></code></pre>
    </div>

    <script>
        // Simular las funciones necesarias
        let openFiles = new Map();
        let activeFile = null;
        let recentFiles = [];
        
        // Funci√≥n para a√±adir output
        function addOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }
        
        // Funci√≥n para limpiar output
        function clearOutput() {
            document.getElementById('output').innerHTML = '<div class="info">[INFO] Output limpiado...</div>';
        }
        
        // Simular path.basename
        const path = {
            basename: (filePath) => {
                return filePath.split(/[\\/]/).pop();
            },
            extname: (filePath) => {
                const name = path.basename(filePath);
                const lastDot = name.lastIndexOf('.');
                return lastDot > 0 ? name.substring(lastDot) : '';
            }
        };
        
        // Funci√≥n para obtener lenguaje
        function getLanguageFromFile(filePath) {
            const ext = path.extname(filePath).toLowerCase();
            const map = {
                '.c': 'c', '.h': 'c', '.cpp': 'cpp', '.cxx': 'cpp', '.cc': 'cpp',
                '.js': 'javascript', '.jsx': 'javascript', '.ts': 'typescript',
                '.html': 'html', '.htm': 'html', '.css': 'css', 
                '.py': 'python', '.md': 'markdown', '.txt': 'plaintext',
                '.json': 'json', '.xml': 'xml', '.java': 'java',
                '.php': 'php', '.rb': 'ruby', '.go': 'go', '.rs': 'rust'
            };
            return map[ext] || 'plaintext';
        }
        
        // Funci√≥n para detectar archivos binarios
        function isBinaryFile(content) {
            const binaryChars = /[\x00-\x08\x0E-\x1F\x7F]/;
            const sample = content.substring(0, 1024);
            const controlChars = (sample.match(binaryChars) || []).length;
            return (controlChars / sample.length) > 0.3;
        }
        
        // Funci√≥n para formatear tama√±o
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(1024));
            return Math.round(bytes / Math.pow(1024, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Simular funciones de UI
        function createTab(filePath) {
            addOutput(`Tab creada para: ${path.basename(filePath)}`, 'success');
        }
        
        function switchToFile(filePath) {
            activeFile = filePath;
            addOutput(`Cambiado a archivo: ${path.basename(filePath)}`, 'info');
        }
        
        function updateWindowTitle(filePath) {
            document.title = `Samaruc Code - ${path.basename(filePath)}`;
        }
        
        function addToRecentFiles(filePath) {
            recentFiles.unshift(filePath);
            if (recentFiles.length > 10) recentFiles.pop();
            addOutput(`A√±adido a recientes: ${path.basename(filePath)}`, 'info');
        }
        
        // Funci√≥n para mostrar c√≥digo con resaltado de sintaxis
        function displayCodeWithSyntaxHighlight(filePath, content, language) {
            const codeContainer = document.getElementById('code-container');
            const fileInfo = document.getElementById('file-info');
            const codeDisplay = document.getElementById('code-display');
            
            // Mostrar informaci√≥n del archivo
            const fileSize = formatFileSize(content.length);
            const lines = content.split('\n').length;
            fileInfo.textContent = `üìÑ ${path.basename(filePath)} | ${language.toUpperCase()} | ${fileSize} | ${lines} l√≠neas`;
            
            // Establecer el lenguaje y el contenido
            codeDisplay.className = `language-${language}`;
            codeDisplay.textContent = content;
            
            // Aplicar resaltado de sintaxis
            if (typeof Prism !== 'undefined') {
                Prism.highlightElement(codeDisplay);
                addOutput(`‚ú® Resaltado de sintaxis aplicado (${language})`, 'success');
            } else {
                addOutput('‚ö†Ô∏è Prism.js no disponible, mostrando texto plano', 'warning');
            }
            
            // Mostrar el contenedor
            codeContainer.style.display = 'block';
        }
        
        // Funci√≥n principal: openFileInEditor
        function openFileInEditor(filePath, content, isNew = false) {
            addOutput(`openFileInEditor llamada: ${filePath}`, 'info');
            
            if (!filePath || content === undefined) {
                addOutput('Error: Par√°metros inv√°lidos', 'error');
                return;
            }
            
            if (openFiles.has(filePath)) {
                switchToFile(filePath);
                addOutput(`Archivo ya abierto: ${path.basename(filePath)}`, 'warning');
                return;
            }
            
            const language = getLanguageFromFile(filePath);
            addOutput(`Detectado lenguaje: ${language}`, 'info');
            
            if (typeof content !== 'string') {
                try {
                    content = String(content);
                } catch (error) {
                    addOutput('Error: Contenido no v√°lido', 'error');
                    return;
                }
            }
            
            if (content.length > 2 * 1024 * 1024) {
                const fileSize = (content.length / (1024 * 1024)).toFixed(2);
                if (!confirm(`Archivo muy grande (${fileSize}MB). ¬øContinuar?`)) {
                    addOutput('Apertura cancelada por tama√±o', 'warning');
                    return;
                }
            }
            
            if (isBinaryFile(content)) {
                if (!confirm(`Archivo binario detectado. ¬øAbrir como texto?`)) {
                    addOutput('Apertura de binario cancelada', 'warning');
                    return;
                }
            }
            
            openFiles.set(filePath, {
                content: content,
                modified: isNew,
                isNew: isNew,
                language: language,
                fileSize: content.length,
                lastModified: new Date(),
                encoding: 'utf-8'
            });
            
            createTab(filePath);
            switchToFile(filePath);
            updateWindowTitle(filePath);
            
            // Mostrar c√≥digo con resaltado de sintaxis
            displayCodeWithSyntaxHighlight(filePath, content, language);
            
            if (!isNew && (filePath.includes('/') || filePath.includes('\\\\'))) {
                addToRecentFiles(filePath);
            }
            
            addOutput(`‚úÖ Archivo abierto: ${path.basename(filePath)} (${language}, ${formatFileSize(content.length)})`, 'success');
        }
        
        // Funci√≥n de prueba del di√°logo HTML5
        function testFileDialog() {
            addOutput('Probando di√°logo HTML5...', 'info');
            
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.c,.h,.cpp,.js,.html,.css,.py,.md,.txt,*';
            input.multiple = false;
            input.style.display = 'none';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    addOutput(`Archivo seleccionado: ${file.name}`, 'info');
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result;
                        openFileInEditor(file.name, content, true);
                    };
                    
                    reader.onerror = () => {
                        addOutput(`Error leyendo archivo: ${file.name}`, 'error');
                    };
                    
                    reader.readAsText(file, 'utf-8');
                } else {
                    addOutput('No se seleccion√≥ archivo', 'warning');
                }
                
                // Limpiar
                document.body.removeChild(input);
            };
            
            input.oncancel = () => {
                addOutput('Selecci√≥n cancelada', 'info');
                document.body.removeChild(input);
            };
            
            document.body.appendChild(input);
            input.click();
        }
        
        // Funci√≥n de debug
        function testDebug() {
            addOutput('=== DEBUG INFO ===', 'info');
            addOutput(`openFiles: ${openFiles.size} archivos`, 'info');
            addOutput(`activeFile: ${activeFile || 'ninguno'}`, 'info');
            addOutput(`recentFiles: ${recentFiles.length} archivos`, 'info');
            addOutput(`FileReader disponible: ${typeof FileReader !== 'undefined'}`, 'info');
            addOutput(`Blob disponible: ${typeof Blob !== 'undefined'}`, 'info');
            addOutput('=== FIN DEBUG ===', 'info');
        }
        
        // Funci√≥n de prueba directa
        function testDirectOpen() {
            addOutput('Probando apertura directa...', 'info');
            
            const testContent = `#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Estructura para demostrar resaltado
typedef struct {
    char name[50];
    int age;
    float height;
} Person;

// Funci√≥n para crear una persona
Person* createPerson(const char* name, int age, float height) {
    Person* p = (Person*)malloc(sizeof(Person));
    if (p == NULL) {
        fprintf(stderr, "Error: No se pudo asignar memoria\\n");
        return NULL;
    }
    
    strncpy(p->name, name, sizeof(p->name) - 1);
    p->name[sizeof(p->name) - 1] = '\\0';
    p->age = age;
    p->height = height;
    
    return p;
}

// Funci√≥n principal
int main() {
    printf("=== üêü Samaruc Code - Prueba de Resaltado de Sintaxis ===\\n");
    
    // Crear una persona de ejemplo
    Person* person = createPerson("Juan P√©rez", 25, 1.75f);
    
    if (person != NULL) {
        printf("Persona creada:\\n");
        printf("  Nombre: %s\\n", person->name);
        printf("  Edad: %d a√±os\\n", person->age);
        printf("  Altura: %.2f metros\\n", person->height);
        
        // Liberar memoria
        free(person);
        printf("\\n‚úÖ Memoria liberada correctamente\\n");
    } else {
        printf("‚ùå Error al crear la persona\\n");
        return 1;
    }
    
    // Bucle de ejemplo
    printf("\\nContando del 1 al 5:\\n");
    for (int i = 1; i <= 5; i++) {
        printf("%d ", i);
    }
    printf("\\n");
    
    printf("\\nüéâ ¬°Programa ejecutado correctamente!\\n");
    return 0;
}`;
            
            openFileInEditor('ejemplo-sintaxis.c', testContent, true);
        }
        
        // Funci√≥n de prueba C++
        function testCppExample() {
            addOutput('Probando ejemplo C++...', 'info');
            
            const cppContent = `#include <iostream>
#include <vector>
#include <string>
#include <algorithm>

// Clase de ejemplo
class Estudiante {
private:
    std::string nombre;
    int edad;
    std::vector<float> calificaciones;

public:
    // Constructor
    Estudiante(const std::string& n, int e) : nombre(n), edad(e) {}
    
    // M√©todo para agregar calificaci√≥n
    void agregarCalificacion(float calif) {
        if (calif >= 0.0f && calif <= 10.0f) {
            calificaciones.push_back(calif);
        }
    }
    
    // M√©todo para calcular promedio
    float calcularPromedio() const {
        if (calificaciones.empty()) return 0.0f;
        
        float suma = 0.0f;
        for (const auto& calif : calificaciones) {
            suma += calif;
        }
        return suma / calificaciones.size();
    }
    
    // Getters
    const std::string& getNombre() const { return nombre; }
    int getEdad() const { return edad; }
    
    // M√©todo para mostrar informaci√≥n
    void mostrarInfo() const {
        std::cout << "Estudiante: " << nombre << std::endl;
        std::cout << "Edad: " << edad << " a√±os" << std::endl;
        std::cout << "Promedio: " << calcularPromedio() << std::endl;
    }
};

int main() {
    std::cout << "=== üêü Samaruc Code - Ejemplo C++ ===" << std::endl;
    
    // Crear estudiante
    Estudiante est("Mar√≠a Garc√≠a", 20);
    
    // Agregar calificaciones
    std::vector<float> califs = {8.5f, 9.2f, 7.8f, 9.0f, 8.7f};
    
    for (const auto& calif : califs) {
        est.agregarCalificacion(calif);
    }
    
    // Mostrar informaci√≥n
    est.mostrarInfo();
    
    // Usar algoritmos STL
    std::vector<int> numeros = {5, 2, 8, 1, 9, 3};
    std::sort(numeros.begin(), numeros.end());
    
    std::cout << "\\nN√∫meros ordenados: ";
    for (const auto& num : numeros) {
        std::cout << num << " ";
    }
    std::cout << std::endl;
    
    std::cout << "\\nüéâ ¬°Ejemplo C++ completado!" << std::endl;
    return 0;
}`;
            
            openFileInEditor('ejemplo-cpp.cpp', cppContent, true);
        }
    </script>
</body>
</html>
