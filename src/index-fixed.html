<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SamaruC Code</title>
    <link rel="icon" type="image/svg+xml" href="assets/favicon.svg">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="app">
        <!-- Barra de herramientas -->
        <div class="toolbar">
            <div class="toolbar-section">
                <button id="new-file-btn" class="btn btn-primary tooltip" title="Nuevo archivo (Ctrl+N)">
                    <span class="icon">üìÑ</span>
                </button>
                <button id="open-file-btn" class="btn btn-primary tooltip" title="Abrir archivo (Ctrl+O)">
                    <span class="icon">üìÅ</span>
                </button>
                <button id="save-file-btn" class="btn btn-primary tooltip" title="Guardar (Ctrl+S)">
                    <span class="icon">üíæ</span>
                </button>
            </div>
            <div class="toolbar-section">
                <button id="compile-btn" class="btn btn-success" title="Compilar (F5)">
                    <span class="icon">üî®</span> Compilar
                </button>
                <button id="run-btn" class="btn btn-success" title="Compilar y Ejecutar (F6)">
                    <span class="icon">‚ñ∂Ô∏è</span> Ejecutar
                </button>
            </div>
            <div class="toolbar-section">
                <select id="template-select" class="form-control">
                    <option value="">Seleccionar plantilla...</option>
                    <option value="basic-game">Juego B√°sico</option>
                    <option value="c-basic">Programa B√°sico C</option>
                    <option value="c-struct">Con Estructuras</option>
                </select>
                <button id="load-template-btn" class="btn btn-info" title="Cargar plantilla">
                    <span class="icon">‚¨áÔ∏è</span>
                </button>
            </div>
        </div>

        <!-- Panel principal -->
        <div class="main-panel">
            <!-- Explorador de archivos -->
            <div class="sidebar">
                <div class="sidebar-header">
                    <h3><span class="icon">üìÇ</span> Explorador</h3>
                </div>
                <div class="file-explorer" id="file-explorer">
                    <div class="no-project">
                        <p>No hay proyecto abierto</p>
                        <button id="open-project-btn" class="btn btn-secondary">
                            <span class="icon">üìÅ</span> Abrir Proyecto
                        </button>
                    </div>
                </div>
            </div>

            <!-- Editor -->
            <div class="editor-container">
                <div class="editor-tabs" id="editor-tabs">
                    <!-- Las pesta√±as se agregar√°n din√°micamente -->
                    <div class="tab-placeholder" style="padding: 8px 12px; color: #969696; font-size: 13px;">
                        Cargando editor...
                        <button onclick="createNewFile()" style="margin-left: 10px; background: #007ACC; color: white; border: none; padding: 4px 8px; border-radius: 3px; cursor: pointer;">+ Nueva pesta√±a</button>
                    </div>
                </div>
                <div class="editor-content">
                    <div id="monaco-editor" class="monaco-editor-container">
                        <!-- Monaco Editor se carga aqu√≠ -->
                        <div style="width: 100%; height: 100%; display: flex; flex-direction: column; background: #1E1E1E; color: #D4D4D4;">
                            <div style="background: #2d2d30; padding: 8px 12px; border-bottom: 1px solid #3e3e42; font-size: 13px; display: flex; justify-content: space-between;">
                                <span style="color: #ffffff;">üêü SamaruC Code - Editor C</span>
                                <span id="editor-status" style="color: #ffa500; font-size: 11px;">Cargando Monaco...</span>
                            </div>
                            <div id="monaco-loading" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #ffffff;">
                                <div style="text-align: center;">
                                    <div style="font-size: 24px; margin-bottom: 10px;">üêü</div>
                                    <div>Cargando Monaco Editor...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Panel inferior -->
        <div class="bottom-panel">
            <div class="panel-tabs">
                <button class="panel-tab active" data-panel="output">
                    <span class="icon">üìü</span> Salida
                </button>
                <button class="panel-tab" data-panel="terminal">
                    <span class="icon">üíª</span> Terminal
                </button>
                <button class="panel-tab" data-panel="problems">
                    <span class="icon">‚ö†Ô∏è</span> Problemas
                </button>
            </div>
            <div class="panel-content">
                <div id="output-panel" class="panel-section active">
                    <div id="output-content" class="console-output">
                        <div class="output-line success">üêü SamaruC Code iniciado - Monaco Editor cargando...</div>
                    </div>
                </div>
                <div id="terminal-panel" class="panel-section">
                    <div id="terminal-content" class="terminal-output">
                        <!-- Terminal integrada -->
                        <!-- Bot√≥n temporal de debug -->
                        <div style="position: absolute; top: 5px; right: 5px; z-index: 1000;">
                            <button onclick="debugTerminalStatus(); console.log('Debug terminal ejecutado')" style="background: #ff6b6b; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px; margin-right: 4px;">üêõ Debug</button>
                            <button onclick="testTerminalSwitch()" style="background: #4CAF50; color: white; border: none; padding: 4px 8px; border-radius: 3px; font-size: 11px;">üß™ Test</button>
                        </div>
                    </div>
                </div>
                <div id="problems-panel" class="panel-section">
                    <div id="problems-content" class="problems-list">
                        <div class="no-problems">No hay problemas detectados</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ===== GESTI√ìN DE TEMAS =====
        function applyTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            console.log('üé® Aplicando tema:', theme);
            
            // Actualizar Monaco si est√° disponible
            if (window.monacoInstance) {
                const monacoTheme = theme === 'dark' ? 'vs-dark' : 'vs';
                window.monaco.editor.setTheme(monacoTheme);
            }
            
            addOutputLine(`üé® Tema cambiado a: ${theme}`, 'info');
        }
        
        // ===== VARIABLES GLOBALES =====
        let monacoInstance = null;
        let openFiles = new Map();
        let activeFile = null;
        let fileCounter = 1;
        
        // ===== FUNCIONES DE UTILIDAD =====
        function updateStatus(message, color = '#ffa500') {
            const statusElement = document.getElementById('editor-status');
            if (statusElement) {
                statusElement.textContent = message;
                statusElement.style.color = color;
            }
        }
        
        function addOutputLine(message, type = 'info') {
            const output = document.getElementById('output-content');
            if (output) {
                const line = document.createElement('div');
                line.className = 'output-line';
                line.style.color = type === 'success' ? '#4CAF50' : 
                                  type === 'error' ? '#F44336' : 
                                  type === 'warning' ? '#FF9800' : '#ffffff';
                line.textContent = message;
                output.appendChild(line);
                output.scrollTop = output.scrollHeight;
            }
        }
        
        // ===== FUNCIONES DE EDITOR =====
        window.getEditorContent = function() {
            return monacoInstance ? monacoInstance.getValue() : '';
        };
        
        window.setEditorContent = function(content) {
            if (monacoInstance) {
                monacoInstance.setValue(content || '');
            }
        };
        
        function createNewFile() {
            const fileName = `nuevo${fileCounter}.c`;
            const filePath = `temp://${fileName}`;
            const defaultContent = `#include <stdio.h>

int main() {
    printf("¬°Hola desde SamaruC Code!\\n");
    printf("Archivo: ${fileName}\\n");
    return 0;
}`;
            
            fileCounter++;
            
            if (monacoInstance) {
                monacoInstance.setValue(defaultContent);
                updateStatus('Archivo creado', '#4CAF50');
                addOutputLine(`üìÑ Archivo ${fileName} creado`, 'success');
            } else {
                addOutputLine('‚ùå Monaco Editor no disponible', 'error');
            }
        }
        
        function openFileInEditor(filePath, content, isNew = false) {
            if (monacoInstance) {
                monacoInstance.setValue(content || '');
                const fileName = filePath.split(/[\/\\]/).pop();
                updateStatus(`Archivo: ${fileName}`, '#4CAF50');
                addOutputLine(`üìÑ Archivo ${fileName} abierto`, 'success');
            } else {
                addOutputLine('‚ùå Monaco Editor no disponible', 'error');
            }
        }
        
        // ===== CARGA DE MONACO EDITOR =====
        function loadMonacoEditor() {
            console.log('üîÑ Intentando cargar Monaco Editor...');
            
            if (window.monaco) {
                console.log('‚úÖ Monaco ya disponible');
                createMonacoEditor();
                return;
            }
            
            updateStatus('Cargando Monaco Editor...', '#2196F3');
            const basePath = window.location.href.replace('/src/index.html', '');
            console.log('üìÇ Base path:', basePath);
            
            // Cargar CSS
            const css = document.createElement('link');
            css.rel = 'stylesheet';
            css.href = basePath + '/src/monaco/vs/editor/editor.main.css';
            css.onload = () => {
                console.log('‚úÖ CSS de Monaco cargado');
                loadMonacoScript(basePath);
            };
            css.onerror = (error) => {
                console.error('‚ùå Error cargando CSS de Monaco:', error);
                showMonacoError('Error cargando CSS de Monaco');
            };
            document.head.appendChild(css);
        }
        
        function loadMonacoScript(basePath) {
            console.log('üìù Cargando loader de Monaco...');
            const loader = document.createElement('script');
            loader.src = basePath + '/src/monaco/vs/loader.js';
            loader.onload = () => {
                console.log('‚úÖ Loader de Monaco cargado');
                configureMonaco(basePath);
            };
            loader.onerror = (error) => {
                console.error('‚ùå Error cargando loader de Monaco:', error);
                showMonacoError('Error cargando loader de Monaco');
            };
            document.head.appendChild(loader);
        }
        
        function configureMonaco(basePath) {
            console.log('‚öôÔ∏è Configurando Monaco...');
            
            if (typeof require === 'undefined') {
                console.error('‚ùå require no est√° disponible');
                showMonacoError('Entorno AMD no disponible');
                return;
            }
            
            require.config({ paths: { 'vs': basePath + '/src/monaco/vs' } });
            window.MonacoEnvironment = {
                getWorkerUrl: () => basePath + '/src/monaco/vs/base/worker/workerMain.js'
            };
            
            console.log('üîß Cargando editor principal de Monaco...');
            require(['vs/editor/editor.main'], 
                () => {
                    console.log('‚úÖ Monaco editor main cargado');
                    setTimeout(() => {
                        if (window.monaco) {
                            console.log('üéâ Monaco disponible, creando editor');
                            createMonacoEditor();
                        } else {
                            console.error('‚ùå Monaco no disponible despu√©s de cargar');
                            showMonacoError('Monaco no se carg√≥ correctamente');
                        }
                    }, 500);
                },
                (error) => {
                    console.error('‚ùå Error cargando Monaco editor main:', error);
                    showMonacoError('Error cargando Monaco editor');
                }
            );
        }
        
        function createMonacoEditor() {
            console.log('üé® Creando instancia de Monaco Editor...');
            
            try {
                const container = document.getElementById('monaco-editor');
                if (!container) {
                    console.error('‚ùå Contenedor monaco-editor no encontrado');
                    showMonacoError('Contenedor no encontrado');
                    return;
                }
                
                console.log('üì¶ Contenedor encontrado, limpiando...');
                container.innerHTML = '';
                
                // Contenido inicial
                let initialContent = `#include <stdio.h>

int main() {
    printf("¬°Hola desde SamaruC Code!\\n");
    return 0;
}`;
                
                console.log('üîß Creando editor con window.monaco:', !!window.monaco);
                monacoInstance = window.monaco.editor.create(container, {
                    value: initialContent,
                    language: 'c',
                    theme: 'vs-dark',
                    fontSize: 14,
                    automaticLayout: true,
                    minimap: { enabled: true },
                    lineNumbers: 'on',
                    scrollBeyondLastLine: false,
                    wordWrap: 'on'
                });
                
                console.log('‚úÖ Editor creado exitosamente');
                
                // Configurar evento de cambios
                monacoInstance.onDidChangeModelContent(() => {
                    // Detectar cambios en el c√≥digo
                });
                
                // Exponer globalmente
                window.editor = monacoInstance;
                window.monacoInstance = monacoInstance;
                window.monaco = window.monaco;
                
                updateStatus('Monaco Editor activo', '#4CAF50');
                addOutputLine('‚úÖ Monaco Editor funcionando', 'success');
                console.log('üéâ Monaco Editor completamente inicializado');
                
            } catch (error) {
                console.error('‚ùå Error creando Monaco Editor:', error);
                showMonacoError('Error creando editor: ' + error.message);
            }
        }
        
        function showMonacoError(errorMessage) {
            console.error('‚ö†Ô∏è Error en Monaco Editor:', errorMessage);
            updateStatus('Error cargando Monaco', '#F44336');
            addOutputLine('‚ùå Error: ' + errorMessage, 'error');
            
            const container = document.getElementById('monaco-editor');
            if (container) {
                container.innerHTML = `
                    <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; color: #F44336; text-align: center; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3 style="color: #F44336; margin-bottom: 10px;">Error cargando Monaco Editor</h3>
                        <p style="color: #ffffff; margin-bottom: 20px;">${errorMessage}</p>
                        <button onclick="location.reload()" style="background: #007ACC; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 14px;">
                            üîÑ Reintentar
                        </button>
                    </div>
                `;
            }
        }
        
        // ===== FUNCI√ìN DE TEST =====
        function testTerminalSwitch() {
            console.log('üß™ === TEST TERMINAL SWITCH ===');
            console.log('1. switchPanel disponible:', !!window.switchPanel);
            console.log('2. Terminal panel existe:', !!document.getElementById('terminal-panel'));
            console.log('3. Panel tabs existen:', document.querySelectorAll('.panel-tab').length);
            
            // Intentar cambiar al terminal
            if (window.switchPanel) {
                console.log('üîÑ Cambiando al terminal...');
                window.switchPanel('terminal');
            } else {
                console.log('‚ùå switchPanel no disponible');
            }
        }
        
        function debugTerminalStatus() {
            console.log('üêõ === DEBUG TERMINAL STATUS ===');
            console.log('Terminal module loaded:', !!window.terminal);
            console.log('Terminal initialized:', !!window.terminalInitialized);
            console.log('XTerm available:', typeof window.Terminal !== 'undefined');
        }
        
        // ===== INICIALIZACI√ìN =====
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ DOM cargado, iniciando aplicaci√≥n...');
            
            // Aplicar tema oscuro por defecto
            applyTheme('dark');
            
            updateStatus('Iniciando SamaruC Code...', '#2196F3');
            addOutputLine('üêü SamaruC Code iniciado', 'success');
            
            // IMPORTANTE: Primero cargar Monaco, DESPU√âS crear pesta√±as
            console.log('üîÑ Cargando Monaco PRIMERO...');
            loadMonacoEditor();
        });
    </script>
    
    <!-- Scripts modulares -->
    <script src="renderer.js"></script>
    <script src="utils/ui.js"></script>
    <script src="file/fileManager.js"></script>
    <script src="events/events.js"></script>
    <script src="terminal/terminal.js"></script>
</body>
</html>
